using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.IO;
using System.Configuration;
using System.Data.SqlClient;

public partial class UserAppDisplay : System.Web.UI.Page
{
     string str = ConfigurationManager.ConnectionStrings["myconnectionstring"].ConnectionString;
    protected void Page_Load(object sender, EventArgs e)
    {
        Label2.Text = Session["username"].ToString();
        SqlConnection con = new SqlConnection(str);
        con.Open();
        SqlCommand com = new SqlCommand("select id,fname from UserReg where uname='" + Session["username"] + "'", con);         
        SqlDataReader reader = com.ExecuteReader();

        reader.Read();
        Label2.Text = reader["fname"].ToString();
        Label1.Text = reader["id"].ToString();


        reader.Close();
        con.Close();
   
         if (!this.IsPostBack)
        {
           
            using (SqlConnection conn = new SqlConnection(str))
            {
                using (SqlDataAdapter daa = new SqlDataAdapter("SELECT  * FROM appuploads", conn))
                {
                    conn.Open();
                    DataSet ds = new DataSet();
                    daa.Fill(ds);
                    DataList1.DataSource = ds;
                    DataList1.DataBind();

                }
            }
        }
                  }

    protected void DownloadFile(object sender, EventArgs e)
    {
        int id = int.Parse((sender as LinkButton).CommandArgument);
     //   byte[] bytes;
        string fileName, contentType;
        using (SqlConnection con = new SqlConnection(str))
        {
            using (SqlCommand cmd = new SqlCommand())
            {
                cmd.CommandText = "select appmt, applogo,orgappname from appuploads where  id=@Id";
                cmd.Parameters.AddWithValue("@Id", id);
                cmd.Connection = con;
                con.Open();
                using (SqlDataReader sdr = cmd.ExecuteReader())
                {
                    sdr.Read();
                    contentType = sdr["applogo"].ToString();
                    fileName = sdr["orgappname"].ToString();
                }
                con.Close();
                /*SqlConnection con1 = new SqlConnection(str);
                SqlCommand cmd1 = new SqlCommand("Insert into appcount(id,name,Appid,MobileType,Appname,count) values(@id1,@na,@appid,@mobiletyoe,@Appname,@count')", con);
               cmd.Parameters.AddWithValue("@id1", id);
                cmd.Parameters.AddWithValue("@na", lname);
                cmd.Parameters.AddWithValue("@UN", uname);
                cmd.Parameters.AddWithValue("@EM", email);
                cmd.Parameters.AddWithValue("@LT", location);
                cmd.Parameters.AddWithValue("@PW", password);
                cmd.Parameters.AddWithValue("@DB", dob);
                cmd.Parameters.AddWithValue("@MO", mobile);
                cmd.Connection = con;
                con.Open();

                cmd.ExecuteNonQuery();

                Response.Write("<script>alert('Record Added');</script>");
                                con.Close();*/


            }
        }
        Response.Clear();
        Response.Buffer = true;
        Response.Charset = "";
        Response.Cache.SetCacheability(HttpCacheability.NoCache);
        Response.ContentType = contentType;
        Response.AppendHeader("Content-Disposition", "attachment; filename=" + fileName);
        Response.Flush();
        Response.End();
    }
}
