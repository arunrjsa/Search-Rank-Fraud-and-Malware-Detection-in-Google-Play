using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Configuration;

public partial class Viewios : System.Web.UI.Page
{
    string str = ConfigurationManager.ConnectionStrings["myconnectionstring"].ConnectionString;
    protected void Page_Load(object sender, EventArgs e)
    {
        Label2.Text = Session["username"].ToString();
        Label12.Text = Request.QueryString["id"].ToString();

        SqlConnection con = new SqlConnection(str);
        con.Open();
        SqlCommand com = new SqlCommand("select id,fname from UserReg where uname='" + Session["username"] + "'", con);
        SqlDataReader reader = com.ExecuteReader();

        reader.Read();
        Label2.Text = reader["fname"].ToString();
        Label1.Text = reader["id"].ToString();


        reader.Close();
        con.Close();

        if (!IsPostBack)
        {
            BindRatings();
        }



    }
    public void BindRatings()
    {
        SqlConnection con = new SqlConnection(str);
        con.Open();
        SqlCommand cmdnew = new SqlCommand("select avg(rating_id) from T_Rating where Appid='" + Label12.Text + "'", con);
        label6.Text = "Average rate for this App is" + "" + cmdnew.ExecuteScalar().ToString();
        SqlCommand cmduser = new SqlCommand("select count(*) from T_Rating where Appid='" + Label12.Text + "'", con);
        label7.Text = cmduser.ExecuteScalar().ToString() + "" + "users have rated this App";
        SqlCommand cmdpos = new SqlCommand("select count(*) from T_Review where Appid='" + Label12.Text + "' and  review_comment like '%ice%' or   review_comment like '%ood%' or review_comment like '%aws%' and Appid='" + Label12.Text + "'", con);
        label8.Text = "Positive comments" + "" + cmdpos.ExecuteScalar().ToString();
        SqlCommand cmdneg = new SqlCommand("select count(*) from T_Review where Appid='" + Label12.Text + "' and review_comment like '%slo%' or  review_comment like '%wors%' or  review_comment like '%bad%' and Appid='" + Label12.Text + "' ", con);
        label9.Text = "Negative comments" + " " + cmdneg.ExecuteScalar(); ToString();
        //  int averageid = Convert.ToUInt32(cmdnew.ExecuteScalar());
        // label2.Text = "Average rate for this product is" + "" + Convert.ToString(averageid);


    }




    protected void LinkButton_Click(object sender, EventArgs e)
    {
        SqlConnection countmaz = new SqlConnection(str);
        int id1 = int.Parse((sender as LinkButton).CommandArgument);

        //   byte[] bytes;
        string fileName, contentType;
        string mobiletype, noext;
        using (SqlConnection con = new SqlConnection(str))
        {
            using (SqlCommand cmd = new SqlCommand())
            {
                cmd.CommandText = "select appmt, applogo,orgappname,appnamewithout from appuploads where  id=@Id";
                cmd.Parameters.AddWithValue("@Id", id1);
                cmd.Connection = con;
                con.Open();
                using (SqlDataReader sdr = cmd.ExecuteReader())
                {
                    sdr.Read();
                    contentType = sdr["applogo"].ToString();
                    fileName = sdr["orgappname"].ToString();
                    mobiletype = sdr["appmt"].ToString();
                    noext = sdr["appnamewithout"].ToString();
                }

                SqlConnection chcecknew = new SqlConnection(str);
                string checks = "select count(*) from downdetails where Name= '" + Label2.Text + "' and Appid='" + id1 + "'";
                SqlCommand checkexist = new SqlCommand(checks, chcecknew);
                chcecknew.Open();
                int avil = Convert.ToInt32(checkexist.ExecuteScalar());
                if (avil >= 5)
                {

                    Response.Redirect("al_down.aspx");
                }
                else
                {

                    SqlConnection conn = new SqlConnection(str);
                    conn.Open();
                    SqlCommand com1 = new SqlCommand("insert into downdetails(Name, Appid, MobileType, Appname) values ('" + Label2.Text + "','" + id1 + "','" + mobiletype + "','" + noext + "')", conn);
                    com1.ExecuteNonQuery();
                    conn.Close();
                    con.Close();
                }
            }


            Response.Clear();
            Response.Buffer = true;
            Response.Charset = "";
            Response.Cache.SetCacheability(HttpCacheability.NoCache);
            Response.ContentType = contentType;
            Response.AppendHeader("Content-Disposition", "attachment; filename=" + fileName);
            Response.Flush();
            Response.End();

        }
    }

    protected void LinkButton2_Click(object sender, EventArgs e)
    {
        int id1 = int.Parse((sender as LinkButton).CommandArgument);
        Response.Redirect("Ratings.aspx?id=" + id1);

    }
    protected void LinkButton3_Click(object sender, EventArgs e)
    {
        int id1 = int.Parse((sender as LinkButton).CommandArgument);
        Response.Redirect("Add_Review.aspx?id=" + id1);

    }
}